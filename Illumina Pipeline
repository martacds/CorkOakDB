:
##
#
#############fastq-dump#############
#
# Built using:
# https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=toolkit_doc&f=fastq-dump
# https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=toolkit_doc&f=std
#
# Downloads .fastq files from a list of SRA numbers
#
# Requires the download of the SRA Toolkit. To do so remotely, use command wget followed by the URL.
# After the download, alter the first line PATH to direct to the folder where fastq-dump is located.
#
# When using, indicate path to the command followed by the list of SRA numbers.
# e.g. ./dwnfastq.sh listSRAnumbers.txt
#

   PATH=$PATH:/home/martasilva/tools/SRAtoolkit-2.9.4/bin/
   export PATH

counter=0
for SRA_ID in `cat $1`
do
   counter=$((counter+1))
   PROJECTNAME=`echo $SRA_ID | cut -c1-6`

   echo ' '
   echo '~~~~~~~~~~~~' $counter ' FASTQ-DUMP ' $SRA_ID '~~~~~~~~~~~~'
   fastq-dump -I --split-files -O /home/martasilva/IlluminaData/fastqfiles/$SRA_ID $SRA_ID
   cd /home/martasilva/IlluminaData/fastqfiles/$SRA_ID
   ls | grep fastq | cut -c1-12 >> /home/martasilva/IlluminaData/listfilenames.txt
   cd /home/martasilva
   chmod -R 755 IlluminaData
   cd /home/martasilva/IlluminaData
   mkdir -p BioProjects
   cd BioProjects
   mkdir -p $PROJECTNAME
done

############hisat2#############
#
# Built using:
# http://ccb.jhu.edu/software/hisat2/manual.shtml#running-hisat2
#
# Runs HISAT2 on the .fastq files.
# Aligns to a genome. Outputs a .sam file.
#
# Necessary to build an index using hisat2-build
#
# Beginning of the illumina datasets' SRAs is specified so it doesnt run on the 454 datasets.
# This is insanely ugly and an alternative is essential.

   PATH=$PATH:/home/martasilva/tools/HISAT2-2.1.0/
   export PATH #alter to match the localization of the hisat2 tool

counter=0
for direc in /home/martasilva/IlluminaData/fastqfiles/*
do
   counter=$((counter+1))
   FILENAME=`echo $direc | cut --delimiter=/ -f6`
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '||' $FILENAME 'HISAT2 ~~~~~~~~~~~~'
   cd $direc
   hisat2 -t --summary-file /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME/logs/loghisat2$FILENAME.txt -x /home/martasilva/tools/HISAT2-2.1.0/qsuber2018/qsuber2018 -1 *'1.fastq' -2 *'2.fastq' -S /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME/$FILENAME.sam

   cd ..
done

#############samtools#############
#
# Built using:
# information in ESTsColdHeat_processing
#
# Runs samtools in the .sam files from gmap
# samtools view 'opens' the .sam file
# samtools sort sorts the .sam and outputs as a .bam

counter=0
for direc in /home/martasilva/IlluminaData/fastqfiles/*
do
   counter=$((counter+1))
   FILENAME=`echo $direc | cut --delimiter=/ -f6`
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| SAMTOOLS' $FILENAME '~~~~~~~~~~~~'
   echo ' '
   echo '    ...thinking...'
   echo ' '
   
   cd /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME
   samtools view -u *$FILENAME.sam | samtools sort -o $FILENAME.bam
   
# -u , opens as uncompressed .sam file
# -o , outputs as a .bam file

   cd ..
done

#############featurecounts#############
#
# Built using:
# http://bioinf.wehi.edu.au/featureCounts/
#

   PATH=$PATH:/home/martasilva/tools/SubRead-v1.6.3/bin/
   export PATH #alter to match the localization of the featureCounts tool

counter=0
for direc in /home/martasilva/IlluminaData/BioProjects/*
do
   counter=$((counter+1))
   PROJECTNAME=`echo $direc | cut --delimiter=/ -f6`

   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME 'FEATURECOUNTS ~~~~~~~~~~~~'
   cd /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME
   featureCounts -a /home/martasilva/CorkOak1.0_genomic.gtf -g gene_name -o 'counts'$PROJECTNAME'.txt' ./*.bam 2>&1 | tee -a ./logs/featurecountslog$PROJECTNAME.txt
# -a , annotation (gtf/gff)
# -g , category for the sorting of the alignment (gene_id/gene_name)
# -o , output as a .txt file
# 2>&1 | tee , will append to a log file and print it on the screen

   cd ..
done

#############stringtie#############
#
# Built using:
# https://ccb.jhu.edu/software/stringtie/index.shtml?t=manual
#
# Will give the TPM and FPKM in an abundance file
# Outputs a .gtf file
#
# Needs the indication of a reference genome as a .gtf file

   PATH=$PATH:/home/martasilva/tools/StringTie-v1.3.5/
   export PATH #alter to match the localization of the stringtie tool

counter=0
for direc in /home/martasilva/IlluminaData/fastqfiles/*
do
   counter=$((counter+1))
   FILENAME=`echo $direc | cut --delimiter=/ -f6`
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   echo '~~~~~~~~~~~~~' $counter $PROJECTNAME '|| STRINGTIE' $FILENAME '~~~~~~~~~~~~~'
   echo '      ...thinking...'
   echo ' '
     
   cd /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME
   stringtie -e /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME/*.bam -A /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME/abundance$FILENAME -G /home/martasilva/CorkOak1.0_genomic.gtf -o /home/martasilva/IlluminaData/BioProjects/$PROJECTNAME/$FILENAME.gtf

   cd ..
done

#############housekeeping#############
#
# sorts output files into folders divided by tool
#

for direc in /home/martasilva/IlluminaData/BioProjects/*
do
   PROJECTNAME=`echo $direc | cut --delimiter=/ -f6`

   cd $direc

   mkdir -p bam
   mkdir -p featurecounts
   mkdir -p stringtie

   mv *.bam ./bam
   mv abundance* ./stringtie
   mv *gtf ./stringtie
   mv counts* ./featurecounts

done

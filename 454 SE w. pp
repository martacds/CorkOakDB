#!/bin/bash
##
#
# Pipeline for 454 datasets of RNA-Seq.
# With pre-processing to remove 5' tags, low quality sequences and empty reads.
#
# fastq-dump : downloads the .fastq files from the SRA number
# tagcleaner : predicts and removes the tags from the sequence
# sickle : removes low-quality sequence
# prinseq : removes right 5% (Ns), improves overall quality
# gmap : maps sequences to genome built previously (gmap_build)
# samtools : converts the .sam into .bam (sorted file)
# featureCounts : outputs raw counts of alignment
# stringtie : outputs TPM/FPKM counts
#
#
# Marta Silva, ITQB
# marcsilva@itqb.unl.pt
#
############# CONFIGURATION #############
#
HOME=/data/biodata
DATA=/data/biodata/454data
SRAID=/data/biodata/454data/454fastq/$SRA_ID
FASTQFILES=/data/biodata/454data/454fastq/$FILENAME
BIO=/data/biodata/454data/BioProjects/$PROJECTNAME
LOGS=/data/biodata/454data/BioProjects/$PROJECTNAME/logs
FASTQDUMP=/data/biodata/tools/fastq-dump/bin
TAGCLEANER=/data/biodata/tools/TagCleaner
SICKLE=/data/biodata/tools/sickle-master
PRINSEQ=/data/biodata/tools/PrinSeq
GMAP=/data/biodata/tools/gmap-2018-07-04/bin
SAMTOOLS=/data/biodata/tools/samtools-1.9/bin
GTF=/data/biodata/rawdata
FEATURECOUNTS=/data/biodata/tools/SubRead/bin
STRINGTIE=/data/biodata/tools/StringTie

############# FASTQ-DUMP #############
#
# Built using:
# https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=toolkit_doc&f=fastq-dump
# https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=toolkit_doc&f=std
#
# Downloads .fastq files from a list of SRA numbers
#
# Requires the download of the SRA Toolkit. To do so remotely, use command wget followed by the URL.
# After the download, alter the first line PATH to direct to the folder where fastq-dump is located.
#
# When using, indicate path to the command followed by the list of SRA numbers.
# e.g. ./dwnfastq.sh listSRAnumbers.txt

   PATH=$PATH:$FASTQDUMP
   export PATH

counter=0
for SRA_ID in `cat $1`
do
   counter=$((counter+1))
   PROJECTNAME=`echo $SRA_ID | cut -c1-6`

   echo ' '
   echo '~~~~~~~~~~~~' $counter ' FASTQ-DUMP ' $SRA_ID '~~~~~~~~~~~~'
   echo ' '
   echo '             ...running fastq-dump...'
   echo ' '

   fastq-dump -O $SRAID $SRA_ID

   cd $SRAID
   ls | grep fastq | cut -c1-12 >> $DATA/listfilenames454.txt
   cd $HOME
   cd $DATA
   mkdir -p BioProjects
   cd BioProjects
   mkdir -p $PROJECTNAME
   cd $PROJECTNAME
   mkdir -p logs

done

############# TAGCLEANER #############
#
# Built using:
# http://tagcleaner.sourceforge.net/manual.html#STANDALONE
#
# Predicts the tag 5' of the .fastq file
# If a tag is present it removes it. If there is no tag, nothing happens.
# In both cases it outputs a file with the prefix 'notag'
#
# Creates a log of the process
# Creates a file to log the numbers and percentages of each command.
# One percentages log per dataset
#

   alias tagcleaner='perl $TAGCLEANER/tagcleaner.pl'

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   echo ''
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| TAGCLEANER PREDICT' $FILENAME '~~~~~~~~~~~~'
   echo ' '

   cd $FASTQFILES
   tagcleaner -verbose -fastq $FILENAME.fastq -predict >> $LOGS/'predict'$FILENAME'.txt'


   if [ `grep -s tag5 $LOGS/'predict'$FILENAME'.txt' | cut -f2` ] ; then

   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| CLEANING TAG5' $FILENAME '~~~~~~~~~~~~'

   TAG=$(grep -s tag5 $LOGS/predict"$FILENAME".txt | cut -f2)
   echo 'Predicted Tag: ' $TAG
   NNN=$(echo "$TAG" | sed 's/N.*//')
   echo 'Clean Tag: ' $NNN

   tagcleaner -verbose -fastq $FILENAME.fastq -tag5 $NNN -mm5 1 -out $BIO/notag$FILENAME -log $LOGS/'tagcleanerlog'$FILENAME'.txt'

   else #iteration for datasets with no tags

   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| NO TAG' $FILENAME '~~~~~~~~~~~~'
   echo ' '

   cp $FILENAME.fastq $BIO/'notag'$FILENAME'.fastq'

   echo '	copied with prefix'
   echo ' '
   echo 'TagCleaner' >> $LOGS/logpercentages$FILENAME.txt
   echo 'no sequences/bases removed' >> $LOGS/logpercentages$FILENAME.txt
   cd ..

   fi

done < "$input"

############# SICKLE #############
#
# Built using:
# https://github.com/najoshi/sickle
#
# Runs Sickle on the .fastq files form tagcleaner.
# Improves the overall quality of the dataset

   PATH=$PATH:$SICKLE
   export PATH

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   cd $BIO
   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| SICKLE' $FILENAME '~~~~~~~~~~~~'

   sickle se -q 20 -l 100 -f 'notag'$FILENAME'.fastq' -t sanger -o 'sickle'$FILENAME'.fastq' | tee $LOGS/'sicklelog'$FILENAME'.txt'

   cd ..

done < "$input"

############# PRINSEQ #############
#
# Built using:
# http://prinseq.sourceforge.net/manual.html#STANDALONE
#
# Runs PrinSeq on the .fastq files from Sickle
# Trims in terms of quality (set as 20) from the left.
# Trims a % form the right (set as 5), which will remove the Ns from the end of the sequence
# Outputs good and bad sequences, and creates a log

   PATH=$PATH:$PRINSEQ
   export PATH

   alias prinseq='perl $PRINSEQ/prinseq-lite.pl'

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   cd $BIO

   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| PRINSEQ' $FILENAME '~~~~~~~~~~~~'

   prinseq -verbose -trim_qual_left 20 -trim_right_p 5 -fastq 'sickle'$FILENAME'.fastq' -out_good 'ps'$FILENAME -out_bad 'psBAD'$FILENAME -log $LOGS/'prinseqlog'$FILENAME'.txt'

   cd ..

done < "$input"

############# GMAP #############
#
# Built using:
# http://manpages.ubuntu.com/manpages/bionic/man1/gmap.1.html
#
# Runs GMAP on the .fastq files from PrinSeq
# Outputs a .sam file per dataset, divided by project
# Necessary to build the genome using gmap_build

   PATH=$PATH:$GMAP
   export PATH

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   cd $BIO

   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| GMAP' $FILENAME '~~~~~~~~~~~~'
   echo ' '
   echo '    ...running gmap...'

   gmap -d QSuber2018 -t 6 -f samse -n 0 $BIO/'ps'$FILENAME'.fastq' > $BIO/$FILENAME.sam 2> $LOGS/'GMAPlog'$FILENAME'.txt'

  cd ..
done < "$input"

############# SAMTOOLS #############
#
# Built using:
# information in ESTsColdHeat_processing
#
# Runs samtools in the .sam files from gmap
# samtools view 'opens' the .sam file
# samtools sort sorts the .sam and outputs as a .bam

   PATH=$PATH:$SAMTOOLS
   export PATH

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   cd $BIO

   echo '~~~~~~~~~~~~' $counter $PROJECTNAME '|| SAMTOOLS' $FILENAME '~~~~~~~~~~~~'
   echo ' '
   echo '    ...running samtools...'
   echo ' '

   $SAMTOOLS/samtools view -bS $FILENAME.sam | $SAMTOOLS/samtools sort -o $FILENAME.bam

   cd ..

done < "$input"

############# FEATURECOUNTS #############
#
# Built using:
# http://bioinf.wehi.edu.au/featureCounts/
#

   PATH=$PATH:$FEATURECOUNTS
   export PATH

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   cd $BIO

   echo ' '
   echo '~~~~~~~~~~~~' $counter $PROJECTNAME 'FEATURECOUNTS ~~~~~~~~~~~~'

   featureCounts -a $GTF/CorkOak1.0_genomic.gtf -g gene_name -o 'counts'$PROJECTNAME'.txt' $BIO/$FILENAME'.bam' 2>&1 | tee -a $LOGS/'featurecountslog'$PROJECTNAME'.txt'

   cd ..
done < "$input"

############# STRINGTIE #############
#
# Built using:
# https://ccb.jhu.edu/software/stringtie/index.shtml?t=manual
#
# Will give the TPM and FPKM in an abundance file
# Outputs a .gtf file
#
# Needs the indication of a reference genome as a .gtf file

   PATH=$PATH:$STRINGTIE
   export PATH

counter=0
input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   counter=$((counter+1))
   PROJECTNAME=`echo $FILENAME | cut -c1-6`

   cd $BIO

   echo '~~~~~~~~~~~~~' $counter $PROJECTNAME '|| STRINGTIE' $FILENAME '~~~~~~~~~~~~~'
   echo ' '
   echo '      ...running stringtie...'

   stringtie $BIO/$FILENAME'.bam' -e -B -A $BIO/abundance$FILENAME -G $GTF/CorkOak1.0_genomic.gtf -o $BIO/$FILENAME'.gtf'

   cd ..
done < "$input"

############# HOUSEKEEPING #############
#
# sorts output files into folders divided by tool
#

input="$DATA/listfilenames454.txt"
while IFS= read -r FILENAME
do
   PROJECTNAME=`echo $FILENAME | cut -c1-6`
   cd $BIO

   mkdir -p notag
   mkdir -p sickle
   mkdir -p prinseq
   mkdir -p gmap
   mkdir -p bam
   mkdir -p featurecounts
   mkdir -p stringtie

   mv sickle* ./sickle
   mv notag* ./notag
   mv *.bam ./bam
   mv *.sam ./gmap
   mv abundance* ./stringtie
   mv *.gtf ./stringtie
   mv counts* ./featurecounts
   mv ps* ./prinseq

done < "$input"
